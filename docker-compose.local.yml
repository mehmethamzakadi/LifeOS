# ============================================
# LifeOS - Local Development Configuration
# ============================================
# Kullanım:
#   docker-compose -f docker-compose.local.yml up -d
#   docker-compose -f docker-compose.local.yml down -v
#   docker-compose -f docker-compose.local.yml logs -f lifeos.api
# ============================================

x-common-healthcheck: &common-healthcheck
  interval: 10s
  timeout: 5s
  retries: 10
  start_period: 10s

services:
  # ===========================================
  # Client Service - Development (Hot Reload)
  # ===========================================
  lifeos.client:
    build:
      context: ./clients/lifeos-client
      dockerfile: Dockerfile.dev
    container_name: lifeos_client_dev
    restart: unless-stopped
    environment:
      # Vite dev server için API URL
      VITE_API_URL: http://localhost:6060
    ports:
      - "5173:5173" # Vite Dev Server
    volumes:
      # Source code'u mount et - hot reload için
      # node_modules ve dist container içinde kalacak (named volume kullanarak)
      - lifeos_client_node_modules:/app/node_modules
      - lifeos_client_dist:/app/dist
      # Tüm proje klasörünü mount et (node_modules ve dist hariç - yukarıdaki named volumes override eder)
      - ./clients/lifeos-client:/app
    depends_on:
      lifeos.api:
        condition: service_started
    networks:
      - lifeos_local_net
    # Vite dev server healthcheck
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5173/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ===========================================
  # API Service - Development (Hot Reload)
  # ===========================================
  lifeos.api:
    build:
      context: .
      dockerfile: src/LifeOS.API/Dockerfile.dev
    container_name: lifeos_api_dev
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:8080
      # Database
      ConnectionStrings__LifeOSPostgreConnectionString: >-
        Host=postgresdb;
        Port=5432;
        Database=LifeOSDb;
        Username=postgres;
        Password=postgres;
        Include Error Detail=true;
        Pooling=true;
        Minimum Pool Size=5;
        Maximum Pool Size=50;
        Connection Idle Lifetime=300;
        Connection Pruning Interval=10;
        Command Timeout=30;
        Timeout=15
      # Redis (service name: redis.cache)
      ConnectionStrings__RedisCache: >-
        redis.cache:6379,
        abortConnect=false,
        connectTimeout=5000,
        syncTimeout=5000,
        connectRetry=3,
        keepAlive=60
      # JWT Security (Development only - use secrets in production!)
      TokenOptions__SecurityKey: "DevSecretKey_32chars_minimum!@#$%"
      # Seq Logging - Docker ortamında service name kullanılır
      Serilog__SeqUrl: http://seq:80
      # Ollama AI
      OllamaOptions__Endpoint: http://ollama:11434
      OllamaOptions__ModelId: qwen2.5:1.5b
      OllamaOptions__ApiKey: ollama
      OllamaOptions__TimeoutMinutes: 2
      OllamaOptions__RetryCount: 3
      OllamaOptions__RetryDelaySeconds: 2
      # CORS Policy (Client Docker container'dan gelen istekler için)
      CorsOptions__AllowedOrigins: "http://localhost:5173,http://lifeos.client"
    depends_on:
      postgresdb:
        condition: service_healthy
      redis.cache:
        condition: service_healthy
      # Ollama opsiyonel - API Ollama olmadan da çalışabilir
      # ollama dependency kaldırıldı - AI özellikleri opsiyonel
    ports:
      - "6060:8080" # API endpoint
    volumes:
      # Hot reload için source code mount - tüm proje klasörünü mount et
      # Build output'ları (bin/obj) named volume'da tutulacak, source code mount edilecek
      - ./src:/src/src
      # Root klasöründeki build props dosyalarını mount et
      - ./Directory.Build.props:/src/Directory.Build.props:ro
      - ./Directory.Packages.props:/src/Directory.Packages.props:ro
      # Build output'ları için named volume (performans için - container içinde kalacak)
      - lifeos_api_bin:/src/src/LifeOS.API/bin
      - lifeos_api_obj:/src/src/LifeOS.API/obj
      # Diğer projelerin build output'ları için de named volumes
      - lifeos_infrastructure_bin:/src/src/LifeOS.Infrastructure/bin
      - lifeos_infrastructure_obj:/src/src/LifeOS.Infrastructure/obj
      - lifeos_application_bin:/src/src/LifeOS.Application/bin
      - lifeos_application_obj:/src/src/LifeOS.Application/obj
      - lifeos_domain_bin:/src/src/LifeOS.Domain/bin
      - lifeos_domain_obj:/src/src/LifeOS.Domain/obj
      - lifeos_persistence_bin:/src/src/LifeOS.Persistence/bin
      - lifeos_persistence_obj:/src/src/LifeOS.Persistence/obj
      # Uploads klasörünü bağlıyoruz
      - ./src/LifeOS.API/wwwroot/uploads:/src/src/LifeOS.API/wwwroot/uploads
    networks:
      - lifeos_local_net
    # Healthcheck devre dışı - curl/wget image'da yok
    # API başlatma sırasında migration ve seed otomatik yapılır
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # PostgreSQL Database - Development
  # ===========================================
  postgresdb:
    image: postgres:16-alpine
    container_name: lifeos_postgres_dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: LifeOSDb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "log_statement=all" # Development için tüm SQL logla
      - "-c"
      - "log_duration=on"
    ports:
      - "5435:5432" # Host'tan erişim için
    volumes:
      - postgres_local_data:/var/lib/postgresql/data
    networks:
      - lifeos_local_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d LifeOSDb"]
      <<: *common-healthcheck

  # ===========================================
  # Redis Cache - Development
  # ===========================================
  redis.cache:
    image: redis:7-alpine
    container_name: lifeos_redis_dev
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379" # Host'tan erişim için
    volumes:
      - redis_local_data:/data
    networks:
      - lifeos_local_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      <<: *common-healthcheck

  # ===========================================
  # Seq Log Management - Development
  # ===========================================
  seq:
    image: datalust/seq:latest
    container_name: lifeos_seq_dev
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_ADMINPASSWORD: Admin123!
    ports:
      - "5341:80" # Seq Web UI
    volumes:
      - seq_local_data:/data
    networks:
      - lifeos_local_net
    # Seq healthcheck - basit bir ping kontrolü yeterli
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ===========================================
  # Ollama AI Service - Development
  # ===========================================
  ollama:
    image: ollama/ollama:latest
    container_name: lifeos_ollama_dev
    restart: unless-stopped
    ports:
      - "11434:11434" # Ollama API
    volumes:
      - ollama_local_data:/root/.ollama
    networks:
      - lifeos_local_net
    # Ollama başlatma süresi uzun olabilir (model yükleme)
    # Healthcheck basit tutuldu - Ollama servisi hazır olmasa bile container çalışmaya devam eder
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 60s
      timeout: 10s
      retries: 1
      start_period: 120s # Ollama başlatma için daha fazla süre

# ===========================================
# Volumes - Local Development
# ===========================================
volumes:
  postgres_local_data:
    name: lifeos_postgres_local
  redis_local_data:
    name: lifeos_redis_local
  seq_local_data:
    name: lifeos_seq_local
  ollama_local_data:
    name: lifeos_ollama_local
  lifeos_client_node_modules:
    name: lifeos_client_node_modules
  lifeos_client_dist:
    name: lifeos_client_dist
  lifeos_api_bin:
    name: lifeos_api_bin
  lifeos_api_obj:
    name: lifeos_api_obj
  lifeos_infrastructure_bin:
    name: lifeos_infrastructure_bin
  lifeos_infrastructure_obj:
    name: lifeos_infrastructure_obj
  lifeos_application_bin:
    name: lifeos_application_bin
  lifeos_application_obj:
    name: lifeos_application_obj
  lifeos_domain_bin:
    name: lifeos_domain_bin
  lifeos_domain_obj:
    name: lifeos_domain_obj
  lifeos_persistence_bin:
    name: lifeos_persistence_bin
  lifeos_persistence_obj:
    name: lifeos_persistence_obj

# ===========================================
# Networks - Local Development
# ===========================================
networks:
  lifeos_local_net:
    name: lifeos_local_network
    driver: bridge
