# ============================================
# LifeOS - Production Configuration
# ============================================
# ÖNEMLİ: Production ortamında .env dosyası ZORUNLUDUR!
#
# Kullanım:
#   1. .env dosyasını oluşturun: cp .env.example .env
#   2. .env dosyasındaki tüm değerleri doldurun
#   3. docker-compose -f docker-compose.prod.yml up -d
#   4. docker-compose -f docker-compose.prod.yml logs -f
#
# Ölçeklendirme:
#   docker-compose -f docker-compose.prod.yml up -d --scale lifeos.api=3
# ============================================

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 30s

x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # ===========================================
  # Client Service - Production
  # ===========================================
  lifeos.client:
    image: ${DOCKER_REGISTRY:-}lifeosclient:${TAG:-latest}
    build:
      context: ./clients/lifeos-client
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-https://api.yourdomain.com}
    container_name: lifeos_client_prod
    restart: always
    expose:
      - "80" # Sadece internal network'ten erişilebilir (nginx üzerinden)
    depends_on:
      lifeos.api:
        condition: service_healthy
    networks:
      - lifeos_prod_net
    <<: *logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

  # ===========================================
  # Nginx Reverse Proxy (Gateway)
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: lifeos_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL sertifikaları için (Let's Encrypt kullanılıyorsa)
      # - ./deploy/nginx/ssl:/etc/nginx/ssl:ro
      # - ./deploy/nginx/certbot:/var/www/certbot:ro
    depends_on:
      lifeos.api:
        condition: service_healthy
      lifeos.client:
        condition: service_healthy
    networks:
      - lifeos_prod_net
    <<: *logging
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      <<: *common-healthcheck

  # ===========================================
  # API Service - Production
  # ===========================================
  lifeos.api:
    image: ${DOCKER_REGISTRY:-}lifeosapi:${TAG:-latest}
    build:
      context: .
      dockerfile: src/LifeOS.API/Dockerfile
      args:
        - CONFIGURATION=Release
    container_name: lifeos_api_prod
    restart: always
    expose:
      - "8080" # Sadece internal network'ten erişilebilir
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://0.0.0.0:8080
      # Database - Production ayarları
      ConnectionStrings__LifeOSPostgreConnectionString: >-
        Host=postgresdb;
        Port=5432;
        Database=${POSTGRES_DB};
        Username=${POSTGRES_USER};
        Password=${POSTGRES_PASSWORD};
        Pooling=true;
        Minimum Pool Size=10;
        Maximum Pool Size=100;
        Connection Idle Lifetime=300;
        Connection Pruning Interval=10;
        Command Timeout=30;
        Timeout=15;
        Include Error Detail=false
      # Redis - Production ayarları (service name: redis.cache)
      ConnectionStrings__RedisCache: >-
        redis.cache:6379,
        password=${REDIS_PASSWORD},
        abortConnect=false,
        connectTimeout=5000,
        syncTimeout=5000,
        connectRetry=3,
        keepAlive=60,
        ssl=false
      # JWT Security
      TokenOptions__SecurityKey: ${TOKEN_SECURITY_KEY}
      # Seq Logging
      Serilog__WriteTo__1__Args__serverUrl: http://seq:80
      # CORS Policy (Production'da sadece kendi domaininden gelen isteklere izin ver)
      # .NET Core array format: __0, __1, __2, etc.
      CorsOptions__AllowedOrigins__0: "${APP_URL:-http://45.143.4.244}"
      CorsOptions__AllowedOrigins__1: "http://lifeos.client"
    volumes:
      # Named Volume kullanıyoruz (Local'deki gibi ./src/... değil)
      - uploads_prod_data:/app/wwwroot/uploads
    depends_on:
      postgresdb:
        condition: service_healthy
      redis.cache:
        condition: service_healthy
    networks:
      - lifeos_prod_net
    <<: *logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

  # ===========================================
  # PostgreSQL Database - Production
  # ===========================================
  postgresdb:
    image: postgres:16-alpine
    container_name: lifeos_postgres_prod
    restart: always
    # ÖNEMLİ: Production'da port dışarıya AÇILMAMALI!
    # ports:
    #   - "5432:5432"         # Sadece gerekirse VPN üzerinden erişim
    expose:
      - "5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    command:
      - "postgres"
      - "-c"
      - "max_connections=300"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=2GB"
      - "-c"
      - "work_mem=8MB"
      - "-c"
      - "maintenance_work_mem=256MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=32MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "log_min_duration_statement=1000" # 1 saniyeden uzun sorguları logla
      - "-c"
      - "log_checkpoints=on"
      - "-c"
      - "log_connections=on"
      - "-c"
      - "log_disconnections=on"
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    networks:
      - lifeos_prod_net
    <<: *logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # ===========================================
  # Redis Cache - Production (Password Protected)
  # ===========================================
  redis.cache:
    image: redis:7-alpine
    container_name: lifeos_redis_prod
    restart: always
    # ÖNEMLİ: Production'da port dışarıya AÇILMAMALI!
    expose:
      - "6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
    volumes:
      - redis_prod_data:/data
    networks:
      - lifeos_prod_net
    <<: *logging
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 768M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================
  # Seq Log Management - Production
  # ===========================================
  seq:
    image: datalust/seq:latest
    container_name: lifeos_seq_prod
    restart: always
    # ÖNEMLİ: Production'da port dışarıya AÇILMAMALI!
    # Nginx üzerinden erişim sağlanabilir
    expose:
      - "80"
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_ADMINPASSWORD: ${SEQ_ADMIN_PASSWORD}
      SEQ_CACHE_SYSTEMRAMTARGET: 256000000
    volumes:
      - seq_prod_data:/data
    networks:
      - lifeos_prod_net
    <<: *logging
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

# ===========================================
# Volumes - Production (Named Volumes)
# ===========================================
volumes:
  postgres_prod_data:
    name: lifeos_postgres_prod
    driver: local
  redis_prod_data:
    name: lifeos_redis_prod
    driver: local
  seq_prod_data:
    name: lifeos_seq_prod
    driver: local
  uploads_prod_data:
    name: lifeos_uploads_prod
    driver: local
# ===========================================
# Networks - Production (Isolated Network)
# ===========================================
networks:
  lifeos_prod_net:
    name: lifeos_prod_network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
